{% extends "base.html" %}

{% block title %}{{ zakupka.purchase_object[:50] }} - Business database{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <a href="{{ url_for('main.index', date_from=date_from, date_to=date_to, search_text=search_text, page=page, per_page=per_page) }}" class="btn btn-outline-secondary btn-sm">
            <svg width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Информация о закупке</h4>
            </div>
            <div class="card-body">
                <!-- Основная информация -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Описание закупки</h5>
                        <p class="lead">{{ zakupka.purchase_object }}</p>
                    </div>
                </div>

                <div class="row">
                    <!-- Левая колонка -->
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th style="width: 40%;">Дата запроса:</th>
                                    <td>{{ zakupka.date_request.strftime('%d.%m.%Y') if zakupka.date_request else '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Цена контракта:</th>
                                    <td><strong class="text-success">{{ zakupka.start_cost_var if zakupka.start_cost_var else (format_price(zakupka.start_cost) if zakupka.start_cost else 'Не указана') }}</strong></td>
                                </tr>
                                <tr>
                                    <th>ID закупки:</th>
                                    <td><code class="fs-5">#{{ zakupka.id }}</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Правая колонка -->
                    <div class="col-md-6">
                        <h6>Контактная информация</h6>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th style="width: 40%;">Покупатель:</th>
                                    <td style="word-break: break-word; white-space: normal;">{{ zakupka.customer or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>
                                        {% if zakupka.email %}
                                            {% if show_masked_email %}
                                                {{ mask_email(zakupka.email) }}
                                                <small class="text-muted">(частично скрыт)</small>
                                            {% else %}
                                                <a href="mailto:{{ zakupka.email }}">{{ zakupka.email }}</a>
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Телефон:</th>
                                    <td>
                                        {% if zakupka.phone %}
                                            {% if show_masked_phone %}
                                                {{ mask_phone(zakupka.phone) }}
                                                <small class="text-muted">(частично скрыт)</small>
                                            {% else %}
                                                <a href="tel:{{ zakupka.phone }}">{{ zakupka.phone }}</a>
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Адрес:</th>
                                    <td style="word-break: break-word; white-space: normal;">{{ zakupka.address or '-' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Предупреждение для неавторизованных -->
                {% if show_masked_email or show_masked_phone %}
                <div class="alert alert-info mt-3">
                    <strong>Обратите внимание:</strong> Контактные данные частично скрыты.
                    {% if not current_user.is_authenticated %}
                        <a href="{{ url_for('auth.login') }}" class="alert-link">Войдите</a> и
                    {% endif %}
                    <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#balanceModal">пополните баланс</a> для полного доступа.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Спецификация -->
{% if specifications %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    Спецификация
                    <span class="badge bg-light text-dark">{{ specifications|length }} поз.</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Товар/услуга</th>
                                <th>Спецификация</th>
                                <th>Количество</th>
                                <th>Цена с НДС</th>
                                <th>Условия оплаты</th>
                                <th>Срок поставки</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spec in specifications %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ spec.product or '-' }}</td>
                                <td>{{ spec.product_specification or '-' }}</td>
                                <td>{{ spec.quantity or '-' }}</td>
                                <td>
                                    {% if spec.price_vat %}
                                        {{ format_price(spec.price_vat) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ spec.terms_of_payment or '-' }}</td>
                                <td>{{ spec.delivery_time or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="alert alert-secondary">
            <strong>Спецификация:</strong> Для данной закупки спецификация отсутствует.
        </div>
    </div>
</div>
{% endif %}

<!-- Дополнительные действия -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.index', date_from=date_from, date_to=date_to, search_text=search_text, page=page, per_page=per_page) }}" class="btn btn-secondary">
                Вернуться к списку
            </a>
            {% if current_user.is_authenticated %}
            <button class="btn btn-outline-primary" onclick="window.print()">
                <svg width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                    <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                    <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                </svg>
                Печать
            </button>
            {% endif %}
        </div>
    </div>
</div>

<style>
    @media print {
        .btn, nav, footer, .alert {
            display: none !important;
        }
    }
</style>
{% endblock %}
