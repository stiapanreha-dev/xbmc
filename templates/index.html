{% extends "base.html" %}

{% block title %}–ó–∞–∫—É–ø–∫–∏ - XBMC{% endblock %}

{% block content %}

{% if not current_user.is_authenticated %}
<div class="alert alert-warning">
    <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø:</strong> –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π.
    <a href="{{ url_for('auth.login') }}" class="alert-link">–í–æ–π–¥–∏—Ç–µ</a> –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
</div>
{% elif show_masked_email %}
<div class="alert alert-info">
    <strong>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:</strong> Email –∞–¥—Ä–µ—Å–∞ —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—ã.
    <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#balanceModal">–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å</a> –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-12">
        <h4>–ó–∞ –ø–µ—Ä–∏–æ–¥</h4>
        <form method="GET" action="{{ url_for('main.index') }}" class="row g-3 align-items-end">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <div class="col-md-2">
                <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="search_text"
                       placeholder="–¢–æ–≤–∞—Ä/—É—Å–ª—É–≥–∞" value="{{ search_text }}">
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </div>
            <div class="col-md-1">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary w-100" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </a>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('main.export_zakupki', date_from=date_from, date_to=date_to, search_text=search_text) }}"
                   class="btn btn-success w-100">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-file-excel" viewBox="0 0 16 16">
                        <path d="M5.18 4.616a.5.5 0 0 1 .704.064L8 7.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 8l2.233 2.68a.5.5 0 0 1-.768.64L8 8.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 8 5.116 5.32a.5.5 0 0 1 .064-.704z"/>
                        <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                    </svg>
                    –≠–∫—Å–ø–æ—Ä—Ç
                </a>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                        <th>–¢–æ–≤–∞—Ä/—É—Å–ª—É–≥–∞</th>
                        <th>–¶–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</th>
                        <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                        <th>Email</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ê–¥—Ä–µ—Å</th>
                        <th>–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% if zakupki %}
                        {% for item in zakupki %}
                        <tr>
                            <td>{{ item.date_request.strftime('%d.%m.%Y') if item.date_request else '' }}</td>
                            <td>{{ item.purchase_object }}</td>
                            <td>{{ '{:,.0f}'.format(item.start_cost).replace(',', ' ') if item.start_cost else '' }}</td>
                            <td>{{ item.customer }}</td>
                            <td>
                                {% if show_masked_email and item.email %}
                                    {{ mask_email(item.email) }}
                                {% else %}
                                    {{ item.email }}
                                {% endif %}
                            </td>
                            <td>{{ item.phone }}</td>
                            <td>{{ item.address }}</td>
                            <td>
                                {% if item.purchase_type is none %}
                                    <a href="{{ url_for('main.specifications', zakupki_id=item.id) }}"
                                       class="btn btn-sm btn-info" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é">
                                        üìã
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="row mt-3 align-items-center">
            <div class="col-md-4">
                <p class="mb-0"><strong>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</strong> {{ total }}</p>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <label for="perPageSelect" class="me-2 text-nowrap">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                    <select id="perPageSelect" class="form-select form-select-sm" onchange="changePerPage(this.value)">
                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
                    </select>
                </div>
            </div>
            {% if total > per_page %}
            <div class="col-md-5">
                <nav>
                    <ul class="pagination justify-content-end mb-0">
                        {% set total_pages = (total / per_page)|round(0, 'ceil')|int %}

                        {# –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ #}
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=page-1, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                &laquo; –ù–∞–∑–∞–¥
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo; –ù–∞–∑–∞–¥</span>
                        </li>
                        {% endif %}

                        {# –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü #}
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.index', page=p, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                    {{ p }}
                                </a>
                            </li>
                            {% elif p == page - 3 or p == page + 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {# –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ #}
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=page+1, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                –í–ø–µ—Ä–µ–¥ &raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">–í–ø–µ—Ä–µ–¥ &raquo;</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function changePerPage(newPerPage) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', newPerPage);
    url.searchParams.set('page', '1'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ per_page
    window.location.href = url.toString();
}
</script>
{% endblock %}
