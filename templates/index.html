{% extends "base.html" %}

{% block title %}Закупки - Business database{% endblock %}

{% block content %}

{% if not current_user.is_authenticated %}
<div class="alert alert-warning">
    <strong>Ограниченный доступ:</strong> Отображаются только последние 50 записей.
    <a href="{{ url_for('auth.login') }}" class="alert-link">Войдите</a> для полного доступа.
</div>
{% elif show_masked_email or show_masked_phone %}
<div class="alert alert-info">
    <strong>Обратите внимание:</strong> Email адреса и телефоны частично скрыты.
    <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#balanceModal">Пополните баланс</a> для полного доступа.
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-12">
        <h4>За период</h4>
        <form method="GET" action="{{ url_for('main.index') }}" class="row g-3 align-items-end" id="searchForm">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <div class="col-md-2">
                <input type="date" class="form-control" id="dateFrom" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="dateTo" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchText" name="search_text"
                       placeholder="Товар/услуга" value="{{ search_text }}">
                <div id="dateWarning" class="form-text text-danger" style="display: none;"></div>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </div>
            <div class="col-md-1">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary w-100" title="Сбросить фильтр">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </a>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('main.export_zakupki', date_from=date_from, date_to=date_to, search_text=search_text) }}"
                   class="btn btn-success w-100">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-file-excel" viewBox="0 0 16 16">
                        <path d="M5.18 4.616a.5.5 0 0 1 .704.064L8 7.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 8l2.233 2.68a.5.5 0 0 1-.768.64L8 8.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 8 5.116 5.32a.5.5 0 0 1 .064-.704z"/>
                        <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                    </svg>
                    Экспорт
                </a>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Дата запроса</th>
                        <th>Товар/услуга</th>
                        <th>Цена контракта</th>
                        <th>Покупатель</th>
                        <th>Email</th>
                        <th>Телефон</th>
                        <th>Адрес</th>
                    </tr>
                </thead>
                <tbody>
                    {% if zakupki %}
                        {% for item in zakupki %}
                        <tr onclick="window.location='{{ url_for('main.zakupki_detail', zakupki_id=item.id, date_from=date_from, date_to=date_to, search_text=search_text, page=page, per_page=per_page) }}'">
                            <td>{{ item.date_request.strftime('%d.%m.%Y') if item.date_request else '' }}</td>
                            <td>{{ item.purchase_object }}</td>
                            <td>{{ item.start_cost_var if item.start_cost_var else (format_price(item.start_cost) if item.start_cost else '') }}</td>
                            <td>{{ item.customer }}</td>
                            <td>
                                {% if show_masked_email and item.email %}
                                    {{ mask_email(item.email) }}
                                {% else %}
                                    {{ item.email }}
                                {% endif %}
                            </td>
                            <td>
                                {% if show_masked_phone and item.phone %}
                                    {{ mask_phone(item.phone) }}
                                {% else %}
                                    {{ item.phone }}
                                {% endif %}
                            </td>
                            <td>{{ item.address }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center">Нет данных</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="row mt-3 align-items-center">
            {% set total_pages = (total / per_page)|round(0, 'ceil')|int %}
            {% set start_record = (page - 1) * per_page + 1 %}
            {% set end_record = [page * per_page, total]|min %}

            <div class="col-md-6 mb-2 mb-md-0">
                <div class="d-flex align-items-center flex-wrap gap-3">
                    <div>
                        <strong>Всего записей:</strong> {{ '{:,}'.format(total).replace(',', ' ') }}
                    </div>
                    <div class="text-muted">
                        Показаны {{ '{:,}'.format(start_record).replace(',', ' ') }}–{{ '{:,}'.format(end_record).replace(',', ' ') }}
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="perPageSelect" class="me-2 text-nowrap mb-0">На странице:</label>
                        <select id="perPageSelect" class="form-select form-select-sm" onchange="changePerPage(this.value)" style="width: 80px;">
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                            <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
                        </select>
                    </div>
                </div>
            </div>

            {% if total > per_page %}
            <div class="col-md-6">
                <nav>
                    <ul class="pagination justify-content-md-end justify-content-center mb-0 flex-wrap">
                        {# Первая страница #}
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=1, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}" title="Первая страница">
                                &laquo;&laquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;&laquo;</span>
                        </li>
                        {% endif %}

                        {# Предыдущая страница #}
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=page-1, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                &laquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                        {% endif %}

                        {# Номера страниц #}
                        {% if total_pages > 1000 %}
                            {# Для больших наборов - показываем текущую страницу и поле ввода #}
                            <li class="page-item active">
                                <span class="page-link">{{ '{:,}'.format(page).replace(',', ' ') }} / {{ '{:,}'.format(total_pages).replace(',', ' ') }}</span>
                            </li>
                        {% else %}
                            {# Обычная пагинация #}
                            {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ p }}</span>
                                </li>
                                {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.index', page=p, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                        {{ p }}
                                    </a>
                                </li>
                                {% elif p == page - 3 or p == page + 3 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {# Следующая страница #}
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=page+1, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}">
                                &raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                        {% endif %}

                        {# Последняя страница #}
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.index', page=total_pages, date_from=date_from, date_to=date_to, search_text=search_text, per_page=per_page) }}" title="Последняя страница">
                                &raquo;&raquo;
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;&raquo;</span>
                        </li>
                        {% endif %}

                        {# Поле для перехода на конкретную страницу #}
                        {% if total_pages > 10 %}
                        <li class="page-item">
                            <div class="input-group input-group-sm" style="width: 140px;">
                                <input type="number" class="form-control" id="gotoPage" placeholder="№ стр"
                                       min="1" max="{{ total_pages }}" value="{{ page }}"
                                       onkeypress="if(event.key==='Enter'){goToPage()}">
                                <button class="btn btn-outline-secondary" type="button" onclick="goToPage()">→</button>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function changePerPage(newPerPage) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', newPerPage);
    url.searchParams.set('page', '1'); // Сбрасываем на первую страницу при изменении per_page
    window.location.href = url.toString();
}

function goToPage() {
    const pageNum = document.getElementById('gotoPage').value;
    if (pageNum && pageNum > 0) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', pageNum);
        window.location.href = url.toString();
    }
}

// Валидация диапазона дат при поиске
document.addEventListener('DOMContentLoaded', function() {
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const searchText = document.getElementById('searchText');
    const dateWarning = document.getElementById('dateWarning');
    const searchForm = document.getElementById('searchForm');
    const MAX_DAYS = 30;

    function validateDateRange() {
        // Проверяем только если есть поисковый запрос
        const hasSearchText = searchText && searchText.value.trim() !== '';

        if (!hasSearchText) {
            dateWarning.style.display = 'none';
            return true;
        }

        const from = dateFrom.value ? new Date(dateFrom.value) : null;
        const to = dateTo.value ? new Date(dateTo.value) : null;

        // Если обе даты заданы, проверяем интервал
        if (from && to) {
            const diffTime = Math.abs(to - from);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays > MAX_DAYS) {
                dateWarning.textContent = `При поиске интервал дат не может превышать ${MAX_DAYS} дней. Период будет скорректирован автоматически.`;
                dateWarning.style.display = 'block';
                return true; // Разрешаем отправку, бэкенд скорректирует
            } else {
                dateWarning.style.display = 'none';
            }
        } else if (!from && !to) {
            // Если даты не заданы при поиске - показываем предупреждение
            dateWarning.textContent = `Поиск будет выполнен за последние ${MAX_DAYS} дней.`;
            dateWarning.style.display = 'block';
        } else {
            dateWarning.style.display = 'none';
        }

        return true;
    }

    // Автоматическая установка/корректировка второй даты
    function autoSetDateTo() {
        if (!dateFrom.value) return;

        const fromDate = new Date(dateFrom.value);
        const maxToDate = new Date(fromDate);
        maxToDate.setDate(maxToDate.getDate() + MAX_DAYS);

        // Ограничиваем текущей датой
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const finalToDate = maxToDate > today ? today : maxToDate;

        // Корректируем если:
        // 1. Поле "Дата до" пустое
        // 2. "Дата до" превышает "Дата от" + 30 дней
        // 3. "Дата до" меньше чем "Дата от"
        const toDate = dateTo.value ? new Date(dateTo.value) : null;
        const shouldCorrect = !dateTo.value ||
                             (toDate && toDate > maxToDate) ||
                             (toDate && toDate < fromDate);

        if (shouldCorrect) {
            // Форматируем дату в YYYY-MM-DD
            const year = finalToDate.getFullYear();
            const month = String(finalToDate.getMonth() + 1).padStart(2, '0');
            const day = String(finalToDate.getDate()).padStart(2, '0');

            dateTo.value = `${year}-${month}-${day}`;
        }
    }

    // Проверка при изменении полей
    if (dateFrom) {
        dateFrom.addEventListener('change', function() {
            autoSetDateTo();
            validateDateRange();
        });
    }
    if (dateTo) dateTo.addEventListener('change', validateDateRange);
    if (searchText) {
        searchText.addEventListener('input', validateDateRange);
        searchText.addEventListener('change', validateDateRange);
    }

    // Проверка при отправке формы
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            if (!validateDateRange()) {
                e.preventDefault();
                return false;
            }
        });
    }

    // Проверка при загрузке страницы
    validateDateRange();
});
</script>
{% endblock %}
